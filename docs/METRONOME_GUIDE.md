# メトロノーム機能 - ユーザーガイド

## 概要
MusicalTimeManagerに統合されたメトロノーム機能により、音楽的時間軸制御システムのテストと使用が格段に向上しました。

## UIコントロール

### 1. メトロノームOn/Offボタン
- **ボタン**: 🔇 Metronome Off / 🥁 Metronome On
- **機能**: メトロノームの有効化/無効化を切り替え
- **状態表示**: ボタンの色と文字で現在の状態を表示

### 2. 音量スライダー
- **コントロール**: 🔊 Vol: [スライダー] [数値]
- **範囲**: 0.0 - 1.0
- **デフォルト**: 0.3
- **機能**: メトロノーム音量をリアルタイム調整

### 3. テストボタン
- **🥁 Metronome Test**: メトロノーム機能の総合テスト
- **❓ Metronome Help**: 使用例とヘルプ表示

## プログラマブルAPI

### MetronomeUtils
```javascript
// 基本制御
MetronomeUtils.enable()        // メトロノーム有効化
MetronomeUtils.disable()       // メトロノーム無効化
MetronomeUtils.toggle()        // 状態切り替え
MetronomeUtils.setVolume(0.5)  // 音量設定
MetronomeUtils.playTest()      // テストパターン再生

// グローバルヘルパー経由
mtm.metronome.enable()
mtm.metronome.disable()
mtm.metronome.toggle()
mtm.metronome.volume(0.5)
mtm.metronome.test()
```

## 拍の種類と音色

### 🔴 Downbeat (小節頭)
- **周波数**: 880Hz
- **音量**: 最大 (100%)
- **長さ**: 0.3秒
- **重要度**: 最高

### 🟡 Strong Beat (強拍)
- **周波数**: 660Hz
- **音量**: 中 (70%)
- **長さ**: 0.2秒
- **重要度**: 高

### 🟢 Weak Beat (弱拍)
- **周波数**: 440Hz
- **音量**: 小 (50%)
- **長さ**: 0.15秒
- **重要度**: 中

### 🔵 Subdivision (細分化)
- **周波数**: 330Hz
- **音量**: 最小 (30%)
- **長さ**: 0.05秒
- **重要度**: 低

## 使用例

### 1. 基本的な使用
```javascript
// 1. メトロノーム有効化
MetronomeUtils.enable();

// 2. 音楽的時間開始
mtm.start();

// 拍がメトロノームで聞こえます
```

### 2. テンポ変更テスト
```javascript
// メトロノーム有効化
MetronomeUtils.enable();

// 4/4拍子で開始
mtm.start();

// 7/8拍子に変更 - メトロノームパターンが変わります
mtm.tempo(140, 7, 8);
```

### 3. フルパフォーマンステスト
- testFullPerformance() 実行時に自動でメトロノーム有効化
- テンポ変更やセクション変化が音で確認可能

## 技術仕様

### Web Audio API実装
- オシレーター: サイン波
- フィルター: ローパスフィルター（拍の種類に応じた周波数）
- エンベロープ: ADSR（アタック・ディケイ）

### 拍子対応
- 4/4拍子: 標準的な強弱パターン
- 3/4拍子: ワルツパターン
- 7/8拍子: 複雑拍子パターン
- その他: 動的な強拍・弱拍判定

### パフォーマンス最適化
- 音源の動的生成・破棄
- メモリリーク防止
- 低レイテンシー再生

## トラブルシューティング

### メトロノームが聞こえない
1. MusicalTimeManagerが初期化されているか確認
2. ブラウザの音声が有効か確認
3. 音量設定を確認

### 拍のタイミングがずれる
1. ブラウザのオーディオレイテンシー確認
2. CPUリソース使用量確認
3. 他のオーディオアプリケーションとの競合確認

## 高精度タイミングシステム (2025-08-19 実装)

### ビートタイミング測定機能
**新機能**: リアルタイムでメトロノームのタイミング精度を測定・分析

#### 測定UIボタン
- **⏱️ Timing Measurement**: 8小節間の総合タイミング測定
- **🎯 Simple Beat Test**: クリーン環境での純粋なタイミング測定（推奨）

#### 測定結果の見方
```
📊 測定完了: 33 サンプル
⏱️ 平均遅延: 2.089ms      ← 理想値: ±3ms以内
📈 標準偏差: 6.192ms       ← 理想値: 5ms以内  
⬆️ 最大遅延: 17.868ms      ← 理想値: 10ms以内
⬇️ 最小遅延: -5.397ms

📈 分布:
   早い(<-1ms): 13 (39.4%)   ← 理想: バランス良く分散
   正確(±1ms): 8 (24.2%)     ← 理想: 50%以上
   遅い(>+1ms): 12 (36.4%)
```

#### 精度評価基準
- **🌟 優秀**: 平均遅延 <2ms, 標準偏差 <1.5ms
- **✅ 良好**: 平均遅延 <5ms, 標準偏差 <3ms  
- **⚠️ 注意**: 平均遅延 <10ms, 標準偏差 <5ms
- **❌ 問題**: 上記を超える場合

### 技術的改善点

#### ルックアヘッドスケジューラー
- **100ms先行予約**: AudioContextで正確な音声タイミングを事前スケジュール
- **10ms間隔チェック**: 高頻度でのタイミング監視
- **二重音声防止**: scheduleBeatsAhead使用で重複再生を解消

#### 高精度タイマー
- **従来**: setTimeout (4ms精度限界) → **改善**: AudioContext基準 1ms間隔
- **相対時間管理**: startTime基準の一貫した時間計算
- **予測可能パターン**: ランダムなばらつきから規則的な遅延パターンへ

### パフォーマンス結果
| 測定項目 | 改善前 | 改善後 | 備考 |
|----------|--------|--------|------|
| 平均遅延 | -496ms | 2-5ms | 業界標準レベル達成 |
| 最大遅延 | 28ms | 5.5ms | 大幅な安定性向上 |
| 一貫性 | ランダム | 規則的 | 予測可能な動作 |

## 今後の拡張予定
- Faustシンセサイザーとの統合
- カスタム音色設定
- MIDI同期機能
- レコーディング機能
- **高精度同期**: 複数デバイス間でのマイクロ秒レベル同期
