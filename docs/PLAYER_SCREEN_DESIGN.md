# Player Screen Design (奏者用画面設計)

## 概要
3人の奏者それぞれに異なる指示を表示する画面の設計ドキュメント。
A4程度のディスプレイまたはiPad等のタブレット縦画面での閲覧を想定。

## 実装ファイル
- **HTML**: `src/player.html`
- **TypeScript**: `src/player.ts`
- **URLパラメータ**: `?player=1`, `?player=2`, `?player=3` で各奏者を識別

---

## 表示要素（優先度順）

### 1. 現在の演奏情報（最優先）
画面上部に常時表示する基本情報

#### a) 現在のパート
- **表示**: `Intro`, `A`, `B`, `C`, `Outro` など
- **目的**: 楽曲構成上の現在位置を把握
- **スタイル**: 大きく目立つフォント、背景色で区別
- **配置**: 画面最上部

#### b) 小節番号
- **表示**: `小節 24` または `Bar 24`
- **目的**: 細かい位置の把握、指揮者や他奏者との同期
- **更新**: リアルタイム（Musical Time Managerから取得）
- **配置**: パート名の横または下

#### c) 経過時間
- **表示**: `02:34` (分:秒) または `154s`
- **目的**: 全体の進行状況把握、録音時の参照
- **更新**: 1秒ごと
- **配置**: 上部情報バー

---

### 2. 視覚的メトロノーム
音ではなく画面の光でリズムを表現

#### 実装案
- **方式A**: 画面端のフラッシュ（上部や下部のバーが点滅）
- **方式B**: 専用インジケーター（円形が拡大縮小）
- **方式C**: 背景の微妙な明滅
- **色**: 拍によって変える（1拍目: 赤、2-4拍目: 白など）
- **配置**: 画面上部または下部、邪魔にならない位置

---

### 3. 楽譜表示エリア
都度生成される楽譜の表示

#### 表示方法
- **Option 1**: SVG形式の楽譜（VexFlowなどのライブラリ使用）
- **Option 2**: 画像形式（事前生成またはリアルタイム生成）
- **Option 3**: 簡易記譜（音名＋リズム記号のテキスト表現）

#### 特徴
- **スクロール**: 現在演奏中の部分を中心に表示
- **ハイライト**: 次に演奏する音符を強調
- **先読み**: 2-4小節先まで表示

#### 配置
- 画面中央のメインエリア（最も広いスペース）

---

### 4. 音楽表現指示

#### a) アーティキュレーション
- **表示要素**: 
  - `staccato` (.)
  - `tenuto` (-)
  - `accent` (>)
  - `marcato` (^)
  - `legato` (スラー)
- **表示方法**: 
  - 楽譜上に記号で表示
  - またはテキストで補足説明
- **配置**: 楽譜内または楽譜直下

#### b) ダイナミクス（強弱記号）
- **表示要素**:
  - `pp`, `p`, `mp`, `mf`, `f`, `ff`
  - `cresc.` (クレッシェンド)
  - `dim.` (ディミヌエンド)
  - `sfz` (スフォルツァンド)
- **表示方法**: 
  - 楽譜上に標準的な音楽記号
  - 現在有効なダイナミクスを別枠で大きく表示
- **配置**: 楽譜内＋画面左側に現在値

---

### 5. 解釈テキスト
楽譜を演奏する際の補足情報

#### 内容例
- 演奏のニュアンス: "軽やかに"、"重厚に"
- 技術的指示: "倍音を強調"、"ノイズ成分を増やす"
- 表現意図: "機械的に正確に"、"人間らしく揺らす"
- 他奏者との関係: "奏者2を模倣"、"奏者3と対比"

#### 表示
- **配置**: 楽譜の下または右側
- **スタイル**: イタリック体、少し小さめのフォント
- **更新**: パートやセクション変更時

---

### 6. 次の演奏情報（Next Performance Info）
**現在演奏中の情報と同等の詳細度を持つプレビュー**

#### 情報の範囲
現在表示されている内容と同じレベルの詳細情報を「次」として表示：
- **楽譜**: 次に演奏する楽譜の全体像
- **アーティキュレーション**: 次のフレーズで使用する奏法
- **ダイナミクス**: 次のセクションの強弱指示
- **解釈テキスト**: 次の演奏のニュアンスや技術的指示
- **パート名**: 次のセクション名（Section B、パートA'など）

#### 表示タイミング
- **開始**: 現在のセクション終了の4-8小節前から表示開始
- **更新**: リアルタイムで「残り小節数」を更新
- **移行**: 新セクション開始と同時に「次」が「現在」になり、新しい「次」を読み込む

#### レイアウト方式

**Option A: 2カラムレイアウト（推奨）**
```
┌─────────────────┬─────────────────┐
│   現在 (Now)     │   次 (Next)      │
│   楽譜           │   楽譜           │
│   mf, staccato  │   f, legato     │
│   "軽快に"       │   "情熱的に"     │
└─────────────────┴─────────────────┘
```
- 画面を左右に分割
- 左: 現在演奏中
- 右: 次に演奏する内容（少し半透明や色を変える）

**Option B: 積み重ねレイアウト**
```
┌─────────────────────────────────┐
│   現在 (Now Playing)             │
│   [楽譜]                        │
│   mf, staccato, "軽快に"        │
├─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┤
│   次 (Next: in 4 bars)          │
│   [楽譜プレビュー]               │
│   f, legato, "情熱的に"          │
└─────────────────────────────────┘
```
- 上: 現在（大きく）
- 下: 次（少し小さく、折りたたみ可能）

**Option C: タブ切り替え**
- デフォルトは「現在」を表示
- 奏者が能動的に「次」タブをタップして確認
- カウントダウンが始まると自動的に「次」を表示

#### カウントダウン表示（自動・手動切り替え対応）

**カウントダウンの種類：文脈に応じた単位と長さ**

1. **拍ベースのカウントダウン（構造化された部分）**
   - **適用場面**: 拍子・小節が明確なセクション
   - **表示例**: 
     - 長い場合: `Next in: 4 bars` → `3 bars` → `2 bars` → `4 beats` → `3` → `2` → `1` → 移行
     - 短い場合: `4 beats` → `3` → `2` → `1` → 移行（小節表示をスキップ）
     - 非常に短い場合: `2` → `1` → 移行（2拍前から）
   - **UI要素**:
     - 数字の大きさが残り時間に応じて拡大
     - 拍ごとに視覚的メトロノームと同期して点滅
     - 最後の1小節は背景色が変化（黄色→オレンジ→赤）
   - **適応ルール**:
     - 次のセクションまで4小節以上 → 小節単位から開始
     - 2-3小節 → 拍単位のみ
     - 1小節以下 → 残りの拍数のみ（最小2拍前）
     - 1拍で切り替わる → プログレスバーのみ、数字なし

2. **秒ベースのカウントダウン（自由な時間進行）**
   - **適用場面**: 
     - 即興セクション（時間のみ指定、拍子なし）
     - フリーテンポの導入部
     - 環境音や持続音のセクション
   - **表示例**: 
     - 長い場合: `Next in: 30s` → `20s` → `10s` → `5` → `4` → `3` → `2` → `1` → 移行
     - 中程度: `10s` → `5` → `4` → `3` → `2` → `1` → 移行
     - 短い場合: `3` → `2` → `1` → 移行（3秒前から）
     - 非常に短い場合: `1` → 移行（1秒前のみ）
   - **UI要素**:
     - プログレスバーで残り時間を視覚化
     - 数字カウントダウンの開始時間は残り時間に応じて調整
     - 視覚的メトロノームは非表示または暗転
   - **適応ルール**:
     - 次のセクションまで30秒以上 → 10秒単位で表示、最後の5秒は1秒単位
     - 10-29秒 → 5秒単位で表示、最後の5秒は1秒単位
     - 5-9秒 → 最初から1秒単位
     - 2-4秒 → 残りの秒数のみカウント
     - 1秒以下 → プログレスバーのみ、数字なし

3. **手動トリガーのカウントダウン（指揮者/コントローラー操作）**
   - **適用場面**: 
     - 全員の準備が整ってから開始したい場面
     - リハーサル時の特定セクション開始
   - **表示**: 
     - `待機中 (Waiting for cue)` → コントローラーからの指示 → `3... 2... 1... Start!`
   - **UI要素**:
     - 「準備完了」ボタン（奏者が押す）
     - 全員が準備完了したらコントローラーからカウントダウン開始
     - 大きなオーバーレイで全画面にカウント表示

4. **瞬時切り替え（カウントダウンなし）**
   - **適用場面**: 
     - 連続的な音楽の流れの中での自然な移行
     - 前のセクションの最後の音が次のセクションの開始と重なる
     - アタッカ（attacca）的な移行
     - 極めて速いテンポでの連続変化
   - **表示**: 
     - 「次」の情報は常に表示されているが、カウントダウンは行わない
     - 切り替わる瞬間に一瞬フラッシュして「次」→「現在」へ
   - **UI要素**:
     - プログレスバーはなし
     - 切り替わり時に全画面が一瞬明滅（0.1秒程度）
     - またはボーダーが一瞬光る

**統一された視覚的表現：円形カウントダウンゲージ**

すべてのカウントダウンと指示を、円形ゲージで統一的に表現します。

### 円形ゲージの仕様

```
        ┌─────────────┐
        │             │
        │     ○       │  ← 通常時：円のアウトライン
        │             │
        └─────────────┘

        ┌─────────────┐
        │             │
        │    ◷ 4      │  ← カウント開始：ゲージが時計回りに減少
        │   bars       │     中央に残り時間/拍数
        └─────────────┘

        ┌─────────────┐
        │             │
        │    ◔ 3      │  ← 進行中：ゲージが徐々に減る
        │   beats      │
        └─────────────┘

        ┌─────────────┐
        │             │
        │    ● 1      │  ← 最後：ほぼ塗りつぶし、強調色
        │             │
        └─────────────┘

        ┌─────────────┐
        │             │
        │   FLASH!    │  ← 実行タイミング：全体が一瞬明滅
        │             │
        └─────────────┘
```

### 用途別の円形ゲージの使い分け

#### 1. セクション進行のカウントダウン
- **配置**: 画面上部中央または「次」エリア内
- **サイズ**: 中程度（直径80-100px）
- **色**:
  - 通常: グレー → 黄色 → オレンジ → 赤（残り時間に応じて変化）
  - ゲージ: 円周に沿って時計回りに描画
- **中央表示**: 
  - `4小節` → `8拍` → `3` → `2` → `1`
  - または `10s` → `5` → `4` → `3` → `2` → `1`
- **アニメーション**: 滑らかに減少、視覚的メトロノームと同期

#### 2. 瞬時指示
- **配置**: 画面中央に大きく表示
- **サイズ**: 大きい（直径150-200px）
- **色**: 
  - 注意: 赤系統（危険度・緊急度を表現）
  - 通常: オレンジ～黄色
- **中央表示**: 
  - `NOW!`（瞬時実行）
  - または残りカウント `3` → `2` → `1` → `NOW!`
- **アニメーション**: 
  - 出現: 拡大アニメーション（スケール 0 → 1）
  - カウント: 急速にゲージ減少
  - 消滅: 縮小またはフェードアウト

#### 3. 手動キュー待機
- **配置**: 画面中央
- **サイズ**: 中〜大（直径100-150px）
- **色**: 青系統（待機状態を表現）
- **中央表示**: 
  - `待機中` または `Waiting`
  - パルスアニメーション（拡大縮小の繰り返し）
- **移行**: 
  - キュー受信 → 色が赤に変化 → カウントダウン開始

#### 4. アタッカ/瞬時切り替え
- **円形ゲージなし**: ゲージを描画しない
- **切り替わり時**: 画面全体またはボーダーが一瞬フラッシュ

### 視覚的表現の統合例

```
┌─────────────────────────────────┐
│  [Player 1]  Intro  Bar:24  02:34│ ← ヘッダー
│              ◷ 4                │ ← 円形ゲージ（次のセクションまで4小節）
│            bars                 │
├─────────────────────────────────┤
│  現在演奏中 (Now Playing)        │
│  [楽譜表示]                     │
│  mf, staccato, "軽快に"         │
├─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┤
│  次 (Next: Section A)           │
│  [楽譜プレビュー]                │
│  f, legato, "情熱的に"          │
└─────────────────────────────────┘

↓ 瞬時指示が来た場合...

┌─────────────────────────────────┐
│  [Player 1]  Intro  Bar:24  02:34│
│              ◷ 4                │ ← セクション進行継続
│            bars                 │
├─────────────────────────────────┤
│          ┌─────────┐            │
│          │  ◔ 2    │            │ ← 瞬時指示の円形ゲージ（大）
│          │         │            │
│          │ C音を吹く │            │
│          └─────────┘            │
│                                 │
│  [通常の表示は背景に半透明で継続] │
└─────────────────────────────────┘

↓ 最後の1拍...

┌─────────────────────────────────┐
│                                 │
│        ┌───────────────┐        │
│        │      ● 1      │        │ ← 大きく強調表示
│        │               │        │    赤色に変化
│        └───────────────┘        │
│                                 │
│  ●●●● (視覚的メトロノームも同期)  │
└─────────────────────────────────┘
```

### 円形ゲージの技術的詳細

**実装方法（SVGまたはCanvas）**

```typescript
// 円形ゲージの描画
interface CircularGauge {
  radius: number;        // 半径
  progress: number;      // 進行度 (0.0 - 1.0)
  color: string;         // ゲージ色
  text: string;          // 中央テキスト
  size: 'small' | 'medium' | 'large';
}

// 使用例
const sectionCountdown = {
  radius: 50,
  progress: 0.75,  // 残り75%
  color: '#FFA500', // オレンジ
  text: '4\nbars',
  size: 'medium'
};

const instantCue = {
  radius: 100,
  progress: 0.3,   // 残り30%
  color: '#FF0000', // 赤
  text: 'NOW!\n\nC音を吹く',
  size: 'large'
};
```

**アニメーション**
- **減少**: `requestAnimationFrame`で滑らかに更新
- **拍同期**: Musical Time Managerからの拍イベントで正確に同期
- **色変化**: 
  - 100% → 50%: 緑～黄色
  - 50% → 25%: 黄色～オレンジ
  - 25% → 0%: オレンジ～赤
- **パルス**: 残り1拍で拡大縮小アニメーション

**カウントダウン開始のトリガー条件**

| セクションタイプ | 残り時間 | 円形ゲージ | 中央テキスト | ゲージ色 |
|---------------|---------|-----------|------------|---------|
| 定常テンポ（4/4など） | 4小節以上 | 中サイズ | `4小節` → `4拍` → `3,2,1` | 黄→赤 |
| 定常テンポ | 2-3小節 | 中サイズ | `12拍` → ... → `3,2,1` | オレンジ→赤 |
| 定常テンポ | 1小節以下 | 中→大サイズ | `3,2,1` または `2,1` | 赤 |
| 定常テンポ | 1拍のみ | 大サイズ（瞬時） | `1` フラッシュ | 赤（点滅） |
| 変拍子 | 8拍以上 | 中サイズ | `8拍` → ... → `3,2,1` | 黄→赤 |
| 変拍子 | 2-7拍 | 中→大サイズ | `4,3,2,1` または `2,1` | オレンジ→赤 |
| フリーテンポ | 30秒以上 | 中サイズ | `30s` → `10s` → `5,4,3,2,1` | 黄→赤 |
| フリーテンポ | 10-29秒 | 中サイズ | `10s` → `5,4,3,2,1` | オレンジ→赤 |
| フリーテンポ | 5-9秒 | 中→大サイズ | `5,4,3,2,1` | オレンジ→赤 |
| フリーテンポ | 2-4秒 | 大サイズ | `3,2,1` または `2,1` | 赤 |
| フリーテンポ | 1秒以下 | 大サイズ（瞬時） | `1` フラッシュ | 赤（点滅） |
| アタッカ/瞬時切り替え | なし | なし | - | 画面フラッシュのみ |
| 手動キュー | 待機中 | 中サイズ（パルス） | `待機中` | 青（パルス） |
| 手動キュー | カウント | 中→大サイズ | `3,2,1,Start!` | 青→赤 |
| **瞬時指示（単発）** | **即座** | **大サイズ（瞬時）** | **`NOW!`+指示** | **赤** |
| **瞬時指示（準備あり）** | **数秒** | **大サイズ** | **`3,2,1,NOW!`+指示** | **オレンジ→赤** |
| 曲の開始 | カウント | 大サイズ（全画面） | `4,3,2,1,Start!` | 黄→赤 |

**重要な設計原則**:
- **統一されたUI**: すべてのカウントダウンと指示を円形ゲージで表現
- **サイズで優先度**: 大きいほど緊急・重要
- **色で状態**: 青（待機）→ 黄（準備）→ オレンジ（間近）→ 赤（直前・実行）
- **レイヤー分離**: セクション進行（小・背景）と瞬時指示（大・前景）は同時表示可能

**インタラクティブ要素（オプション）**

- **準備完了ボタン**: 奏者が次のセクションの準備ができたことを通知
  - コントローラー側で全員の準備状況を確認
  - 全員OKなら自動的にカウントダウン開始
  
- **早送りボタン（リハーサル用）**: 
  - カウントダウンをスキップして即座に次へ移行
  - 練習時のみ有効化

- **一時停止リクエスト**: 
  - 奏者が問題に気づいた時に一時停止を要求
  - コントローラーに通知、全体を停止

- **瞬時指示の確認（オプション）**:
  - 瞬時指示を受け取ったら、奏者が実行完了を通知
  - コントローラーで全員の実行状況を把握
  - 次のアクションのタイミング調整に使用

---

## レイアウト案（縦画面想定）
- セクション進行のプログレスバー: そのパート/セクション全体の進行状況
- 瞬時指示: 独立したアラートシステム、セクション進行とは別レイヤー
- 両者は干渉せず、同時に表示可能

---

## レイアウト案（縦画面想定）

### 案A: 2カラムレイアウト（現在 | 次）

```
┌─────────────────────────────────────────────┐
│  [Player 1]  Intro→A  Bar:24  02:34        │ ← ヘッダー
│  ●●○○ (視覚的メトロノーム)                 │ ← リズム
├──────────────────┬──────────────────────────┤
│  現在 (Now)       │  次 (Next: in 4 bars)    │
├──────────────────┼──────────────────────────┤
│  Section: Intro  │  Section: A              │
│                  │                          │
│  [楽譜表示]       │  [楽譜プレビュー]         │
│   ハイライト      │   少し半透明             │
│                  │                          │
├──────────────────┼──────────────────────────┤
│  Articulation:   │  Articulation:           │
│  staccato        │  legato                  │
│  Dynamics: mf    │  Dynamics: f (cresc.)    │
├──────────────────┼──────────────────────────┤
│  解釈:            │  解釈:                   │
│  "軽快に"         │  "情熱的に、徐々に盛り上げ"│
└──────────────────┴──────────────────────────┘
```

### 案B: 積み重ねレイアウト（現在を大きく、次を下に）

```
┌─────────────────────────────────┐
│  [Player 1]  Intro  Bar:24  02:34│ ← ヘッダー
│  ●●○○ (視覚的メトロノーム)       │ ← リズム
├─────────────────────────────────┤
│  現在演奏中 (Now Playing)        │
├─────────────────────────────────┤
│                                 │
│     [楽譜表示エリア]              │ 
│     (大きく表示)                 │
│                                 │
├─────────────────────────────────┤
│  Articulation: staccato          │
│  Dynamics: mf                    │
│  解釈: "軽快に、リズムを強調"     │
├═════════════════════════════════┤
│  次 (Next: Section A in 4 bars) │ ← 半透明背景
├─────────────────────────────────┤
│  [楽譜プレビュー]                │
│  (少し小さく)                    │
├─────────────────────────────────┤
│  Articulation: legato            │
│  Dynamics: f (cresc.)            │
│  解釈: "情熱的に、徐々に盛り上げ" │
└─────────────────────────────────┘
```

### 案C: スワイプ切り替え（モバイルフレンドリー）

```
┌─────────────────────────────────┐
│  [Player 1]  Intro  Bar:24  02:34│
│  ●●○○  [Now] | [Next: 4 bars]   │ ← タブ
├─────────────────────────────────┤
│                                 │
│     [楽譜表示エリア]              │
│     (現在 or 次をスワイプで切替)  │
│                                 │
├─────────────────────────────────┤
│  Articulation: staccato          │
│  Dynamics: mf                    │
│  解釈: "軽快に"                  │
│                                 │
│  ← スワイプで次を確認             │
└─────────────────────────────────┘
```

**推奨**: 案A（2カラム）または案B（積み重ね）
- タブレット縦画面なら案Bが見やすい（現在に集中、必要時に下を見る）
- より大きな画面（A4ディスプレイ）なら案Aで並列表示

---

## 技術実装検討

### データ送信方法
コントローラー（`controller.ts`）から各奏者画面（`player.ts`）への通信

#### Option 1: BroadcastChannel API
- **利点**: シンプル、同一オリジン内で複数タブ/ウィンドウ間通信
- **用途**: ローカル開発、デモ
```typescript
const channel = new BroadcastChannel('player-instructions');
channel.postMessage({ player: 1, instruction: {...} });
```

#### Option 2: WebSocket
- **利点**: サーバー経由で確実な配信、ネットワーク越しも可能
- **用途**: 本番環境、リモート演奏
- **実装**: Tauriのバックエンドでサーバー構築

#### Option 3: Tauri Event System
- **利点**: Tauriネイティブ、アプリ内通信に最適
- **用途**: デスクトップアプリとして配布する場合
```typescript
import { emit, listen } from '@tauri-apps/api/event';
```

### 楽譜生成ライブラリ
- **VexFlow**: SVGベースの楽譜レンダリング、カスタマイズ可能
- **abcjs**: ABC記譜法からSVG生成、軽量
- **MuseScore.js**: より高度な楽譜、重い

### タイミング同期
- **Musical Time Manager**: 既存の高精度タイミングシステムを活用
- **精度**: 2-5ms（Phase 3で実装済み）
- **同期**: 全ウィンドウで共通のタイムベース

---

## 実装フェーズ

### Phase 1: 基本レイアウト ✅
- [x] `player.html`/`player.ts`の作成
- [x] URLパラメータでの奏者識別
- [ ] 基本的なレイアウト構築（ヘッダー、メインエリア）

### Phase 2: 情報表示
- [ ] 現在のパート表示
- [ ] 小節番号表示
- [ ] 経過時間表示
- [ ] ダイナミクス表示
- [ ] テキスト指示表示

### Phase 3: 視覚的メトロノーム
- [ ] デザイン決定（フラッシュ方式など）
- [ ] Musical Time Managerとの連携
- [ ] 拍の視覚化実装

### Phase 4: 楽譜表示
- [ ] 楽譜生成ライブラリの選定・導入
- [ ] 簡易楽譜の生成テスト
- [ ] ハイライト機能
- [ ] スクロール実装

### Phase 5: 通信システム
- [ ] コントローラーからの指示受信
- [ ] リアルタイム更新
- [ ] 複数奏者への個別配信

### Phase 6: 次の演奏情報
- [ ] セクション予告
- [ ] カウントダウン表示
- [ ] トランジション演出

---

## 将来の拡張案

### 演奏支援機能
- **録音機能**: 自分の演奏を記録・再生
- **練習モード**: テンポ変更、繰り返し再生
- **メモ機能**: 奏者が自分用のメモを追加

### インタラクティブ要素
- **タッチ/クリック**: 楽譜の一部をタップして詳細表示
- **スワイプ**: 前後の楽譜をプレビュー
- **ジェスチャー**: 準備完了のサイン送信

### 視覚的強化
- **テーマ**: ダーク/ライトモード切り替え
- **カラーコーディング**: セクションごとに色分け
- **アニメーション**: 滑らかなトランジション

---

## 参考資料
- [VexFlow Documentation](https://github.com/0xfe/vexflow)
- [Web Audio API - Timing](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
- [BroadcastChannel API](https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel)
- Musical Time Manager実装: `src/audio/musicalTimeManager.ts`
