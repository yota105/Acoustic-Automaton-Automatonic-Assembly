# Player画面 セクション遷移テストガイド

## 🎯 テスト目的

カウントダウンがゼロになった時に、Next セクションが自動的に Current に移行する機能をテストします。

## 📋 テスト環境

- **Tauri アプリケーション**: ブラウザの DevTools コンソールが使えないため、UI ボタンでテスト
- **必要な画面**:
  - Controller 画面 (`src/controller.html`)
  - Player 画面 1つ以上 (`src/player.html?player=1`)

---

## 🧪 テスト手順

### 準備

1. **Tauri アプリを起動**
   ```powershell
   npm run tauri dev
   ```

2. **Controller 画面を開く**
   - メインウィンドウで `src/controller.html` が開いていることを確認

3. **Player 画面を開く**
   - Controller 画面の下部にある "Player 1" リンクをクリック
   - 別ウィンドウで Player 画面が開く

### テスト 1: 基本的なセクション遷移

#### 手順

1. **Controller 画面** で「Player Screen Test Controls」セクションを探す（緑色の枠）

2. **Next セクションを設定**
   - 「Set Next Section」ボタンをクリック
   - Player 画面の下半分（Next セクション）に新しいセクション名が表示される

3. **カウントダウンを開始**
   - Countdown 入力欄に `5` と入力（デフォルト）
   - 「Start Countdown (Smooth)」ボタンをクリック

4. **観察**
   - Player 画面のヘッダー中央に円形カウントダウンが表示される
   - カウントが 5 → 4 → 3 → 2 → 1 → 0 と減少
   - 円の色が緑 → 黄 → オレンジ → 赤 に変化

5. **カウントダウンがゼロになった時**
   - ✅ ヘッダーが白く光る（メトロノームパルス）
   - ✅ Next のセクション名が Current に移動
   - ✅ Next エリアが空になる（または非表示になる）

#### 期待される結果

```
カウント開始前:
┌─────────────────────────────────┐
│ Now: Section A                  │
│ [現在の楽譜]                     │
├─────────────────────────────────┤
│ Next: Section B                 │ ← 「Set Next Section」で設定
│ [次の楽譜]                       │
└─────────────────────────────────┘

↓ カウントダウン 5...4...3...2...1...0

カウント終了後:
┌─────────────────────────────────┐
│ Now: Section B                  │ ← Section B が上に移動！
│ [次の楽譜だったもの]             │
├─────────────────────────────────┤
│ Next: (空)                      │ ← 空になる
│                                 │
└─────────────────────────────────┘
```

---

### テスト 2: 連続したセクション遷移

#### 手順

1. **最初のテスト**
   - 「Set Next Section」ボタンをクリック → Section A が Next に設定される
   - 「Start Countdown (Smooth)」で 5 秒カウント
   - → Section A が Current に移動

2. **2回目のテスト**
   - もう一度「Set Next Section」ボタンをクリック → Section B が Next に設定される
   - 「Start Countdown (Smooth)」で 5 秒カウント
   - → Section B が Current に移動

3. **3回目のテスト**
   - 繰り返す

#### 期待される結果

- ✅ 何度でもセクション遷移が正しく動作する
- ✅ Previous section の内容が失われる（Current が上書きされる）
- ✅ Next が空になる

---

### テスト 3: 短いカウントダウン

#### 手順

1. **カウントダウン時間を変更**
   - Countdown 入力欄に `2` と入力（2秒）

2. **Next セクションを設定**
   - 「Set Next Section」ボタンをクリック

3. **カウントダウンを開始**
   - 「Start Countdown (Smooth)」ボタンをクリック

4. **観察**
   - 2秒でカウントダウンが完了
   - セクション遷移が発生

#### 期待される結果

- ✅ 短時間のカウントダウンでも正しく動作
- ✅ カウントダウンゼロと同時にセクション遷移

---

### テスト 4: 楽譜データの遷移（未実装の場合はスキップ）

現在、楽譜データは初期データのみで、動的な更新は未実装です。
このテストは将来の拡張時に使用します。

---

## 🔍 デバッグ情報の確認

Tauriアプリでは、ログは以下の方法で確認できます：

### Windows (PowerShell)

```powershell
# ターミナルに出力されるログを確認
# アプリ起動時のコンソール出力を見る
```

### ログで確認すべき内容

カウントダウンがゼロになった時のログ:

```
⏰ [Player] Countdown reached zero - triggering section transition
🔄 [Player] Transitioning to next section...
✅ [Player] Section transitioned: Section B
✅ [Player] Next section cleared
🎉 [Player] Section transition complete!
```

---

## 🐛 トラブルシューティング

### 問題: Next セクションが設定されない

**原因**: メッセージングが動作していない可能性

**対処**:
1. Controller と Player が同じアプリインスタンス内で開いているか確認
2. Controller 画面を再読み込み
3. Player 画面を再読み込み

### 問題: カウントダウンが始まらない

**原因**: カウントダウンゲージの初期化失敗

**対処**:
1. Player 画面を再読み込み
2. 「Trigger Metronome Pulse」ボタンでヘッダーが光るか確認
3. 光らない場合、DOM 要素の取得に失敗している

### 問題: カウントダウンがゼロになっても遷移しない

**原因**: `transitionToNextSection()` が呼ばれていない

**対処**:
1. 事前に「Set Next Section」でNextを設定したか確認
2. Next セクションが空の場合、遷移しても見た目が変わらない

---

## 📊 テスト結果チェックリスト

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| Next セクション設定ボタン動作 | ☐ | |
| カウントダウン表示 | ☐ | |
| カウント色変化（緑→黄→赤） | ☐ | |
| カウントゼロ時のパルス | ☐ | |
| Next → Current 遷移 | ☐ | **最重要** |
| Next エリアのクリア | ☐ | |
| 連続遷移の動作 | ☐ | |
| 短時間カウントダウン | ☐ | |

---

## 🎯 成功の定義

以下がすべて確認できたら、テスト成功です：

1. ✅ カウントダウンが正常に表示され、ゼロまでカウントする
2. ✅ カウントゼロと同時に Next → Current への遷移が発生
3. ✅ 遷移後、Next エリアが空になる
4. ✅ 複数回の連続遷移が正常に動作する

---

## 🚀 次のステップ

テストが成功したら、以下の機能を追加できます：

1. **楽譜データの動的更新**: CompositionPlayer からの楽譜送信
2. **アニメーション効果**: フェードイン/アウト
3. **遷移通知**: "Now playing: Section B" などの通知表示
4. **履歴表示**: 過去に演奏したセクションの記録

---

## 📝 メモ

- このテスト機能は開発用です
- 本番環境では、CompositionPlayer が自動的にセクション情報と楽譜を送信します
- テストコントロールは `playerScreenTestControls.ts` に実装されています
