/**
 * Simple Message Sender - „Çπ„Éû„Éõ„Å∏„ÅÆ„ÉÜ„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
 *
 * „Ç≥„É≥„Éà„É≠„Éº„É©„Éº„Åã„ÇâPlayerÁîªÈù¢Ôºà„Çπ„Éû„ÉõÔºâ„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åô„Çã„Ç∑„É≥„Éó„É´„Å™„Ç∑„Çπ„ÉÜ„É†
 * BroadcastChannel„Å®WebSocket„ÅÆ„Éè„Ç§„Éñ„É™„ÉÉ„Éâ„É°„ÉÉ„Çª„É≥„Ç∏„É£„Éº„ÇíÂà©Áî®
 */

import { getControllerMessenger } from './messaging/controllerMessenger';
import type { PerformanceMessage, MessengerStatus } from './messaging/performanceMessenger';

const messenger = getControllerMessenger();

console.log('‚úÖ [SimpleMessageSender] Messenger initialised');
console.log('üìç [SimpleMessageSender] Current origin:', window.location.origin);

messenger.onMessage((message) => {
    console.log('üì® [SimpleMessageSender] Message observed:', message);
});

let diagnosticSubscription: (() => void) | null = null;
let statusSubscription: (() => void) | null = null;

/**
 * „É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó„ÅÆÂÆöÁæ©
 */
export type MessageType =
    | 'test-alert'       // „ÉÜ„Çπ„ÉàÁî®„Ç¢„É©„Éº„Éà
    | 'test-notification' // „ÉÜ„Çπ„ÉàÁî®ÈÄöÁü•
    | 'test-cue'         // „ÉÜ„Çπ„ÉàÁî®„Ç≠„É•„Éº
    | 'countdown'        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
    | 'rehearsal-mark'   // Á∑¥ÁøíÁï™Âè∑
    | 'metronome-pulse'  // „É°„Éà„É≠„Éé„Éº„É†„Éë„É´„Çπ
    | 'current-section'  // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥
    | 'next-section'     // Ê¨°„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥
    | 'diagnostic-ping'  // Êé•Á∂öË®∫Êñ≠: ping
    | 'diagnostic-pong'  // Êé•Á∂öË®∫Êñ≠: pong
    | 'custom';          // „Ç´„Çπ„Çø„É†„É°„ÉÉ„Çª„Éº„Ç∏

/**
 * „É°„ÉÉ„Çª„Éº„Ç∏„Éö„Ç§„É≠„Éº„Éâ
 */
export type MessagePayload = PerformanceMessage;

/**
 * ÂÖ®Player„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
 */
export function sendToAllPlayers(type: MessageType, data?: any) {
    const message = messenger.send({
        type,
        target: 'all',
        data,
    });
    console.log('üì° [Broadcast to ALL]', message);
    return message;
}

/**
 * ÁâπÂÆö„ÅÆPlayer„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
 */
export function sendToPlayer(playerId: string, type: MessageType, data?: any) {
    const message = messenger.send({
        type,
        target: playerId,
        data,
    });
    console.log(`üì° [Sent to Player ${playerId}]`, message);
    return message;
}

/**
 * Ë§áÊï∞„ÅÆÁâπÂÆöPlayer„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
 */
export function sendToPlayers(playerIds: string[], type: MessageType, data?: any) {
    playerIds.forEach(playerId => {
        sendToPlayer(playerId, type, data);
    });
}

/**
 * „ÉÜ„Çπ„Éà„Ç¢„É©„Éº„Éà„ÇíÈÄÅ‰ø°
 */
export function sendTestAlert(message: string, target: 'all' | string = 'all') {
    if (target === 'all') {
        return sendToAllPlayers('test-alert', { message });
    } else {
        return sendToPlayer(target, 'test-alert', { message });
    }
}

/**
 * „ÉÜ„Çπ„ÉàÈÄöÁü•„ÇíÈÄÅ‰ø°
 */
export function sendTestNotification(message: string, duration: number = 3000, target: 'all' | string = 'all') {
    const data = { message, duration };
    if (target === 'all') {
        return sendToAllPlayers('test-notification', data);
    } else {
        return sendToPlayer(target, 'test-notification', data);
    }
}

/**
 * „ÉÜ„Çπ„Éà„Ç≠„É•„Éº„ÇíÈÄÅ‰ø°
 */
export function sendTestCue(message: string, color: string = '#FFA500', target: 'all' | string = 'all') {
    const data = { message, color };
    if (target === 'all') {
        return sendToAllPlayers('test-cue', data);
    } else {
        return sendToPlayer(target, 'test-cue', data);
    }
}

/**
 * „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÇíÈÄÅ‰ø°
 */
export function sendCountdown(bars: number, beats: number = 0, target: 'all' | string = 'all') {
    const data = { bars, beats };
    if (target === 'all') {
        return sendToAllPlayers('countdown', data);
    } else {
        return sendToPlayer(target, 'countdown', data);
    }
}

/**
 * „Ç´„Çπ„Çø„É†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
 */
export function sendCustomMessage(data: any, target: 'all' | string = 'all') {
    if (target === 'all') {
        return sendToAllPlayers('custom', data);
    } else {
        return sendToPlayer(target, 'custom', data);
    }
}

/**
 * 1Áßí„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Âæå„Å´„Éë„É´„Çπ„ÇíÈÄÅ‰ø°
 */
export function sendOneSecondCountdownAndPulse(target: 'all' | string) {
    const resolvedTarget = target ?? 'all';

    const durationMs = 1000;
    const start = performance.now();

    const update = () => {
        const elapsed = performance.now() - start;
        const remaining = Math.max(0, durationMs - elapsed);
        const seconds = remaining / 1000;
        const progress = remaining / durationMs;

        messenger.send({
            type: 'countdown-smooth',
            target: resolvedTarget,
            data: {
                seconds,
                displaySeconds: Math.max(seconds, 0),
                progress
            }
        });

        if (remaining > 0) {
            requestAnimationFrame(update);
        } else {
            messenger.send({
                type: 'metronome-pulse',
                target: resolvedTarget,
                data: {}
            });
        }
    };

    update();
}

/**
 * Á∞°Êòì„ÉÜ„Çπ„ÉàUI‰ΩúÊàê
 */
export function createSimpleTestUI(containerId: string = 'simple-test-container') {
    let container = document.getElementById(containerId);

    if (!container) {
        container = document.createElement('div');
        container.id = containerId;
        container.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 16px;
            z-index: 10000;
            max-width: 320px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        document.body.appendChild(container);
    }

    container.innerHTML = `
        <style>
            .test-ui-title {
                color: #4CAF50;
                font-weight: bold;
                margin-bottom: 12px;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            .test-ui-section {
                margin-bottom: 12px;
            }
            .test-ui-label {
                color: #fff;
                font-size: 12px;
                margin-bottom: 4px;
                display: block;
            }
            .test-ui-select, .test-ui-input {
                width: 100%;
                padding: 6px;
                margin-bottom: 8px;
                border: 1px solid #555;
                border-radius: 4px;
                background: #222;
                color: #fff;
                font-size: 12px;
            }
            .test-ui-btn {
                width: 100%;
                padding: 8px;
                margin-bottom: 6px;
                border: none;
                border-radius: 4px;
                background: #4CAF50;
                color: #fff;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 12px;
            }
            .test-ui-btn:hover {
                background: #45a049;
                transform: translateY(-1px);
            }
            .test-ui-btn:active {
                transform: translateY(0);
            }
            .test-ui-btn.secondary {
                background: #2196F3;
            }
            .test-ui-btn.secondary:hover {
                background: #1976D2;
            }
            .test-ui-btn.warning {
                background: #FF9800;
            }
            .test-ui-btn.warning:hover {
                background: #F57C00;
            }
            .test-ui-close {
                position: absolute;
                top: 8px;
                right: 8px;
                background: transparent;
                border: none;
                color: #fff;
                font-size: 20px;
                cursor: pointer;
                width: 24px;
                height: 24px;
                padding: 0;
                line-height: 1;
            }
            .test-ui-close:hover {
                color: #f44336;
            }
            .test-ui-status {
                margin-top: 8px;
                font-size: 11px;
                color: rgba(255,255,255,0.7);
                line-height: 1.4;
                padding: 8px;
                border-radius: 6px;
                background: rgba(255,255,255,0.06);
            }
            .test-ui-status div + div {
                margin-top: 4px;
            }
            .test-ui-status .warn {
                color: #ffcf66;
            }
            .test-ui-status .error {
                color: #ff9090;
            }
            .test-ui-status .ok {
                color: #8ae6a2;
            }
        </style>
        
        <button class="test-ui-close" onclick="this.parentElement.remove()">√ó</button>
        <div class="test-ui-title">üì± „Çπ„Éû„ÉõÈÄÅ‰ø°„ÉÜ„Çπ„Éà</div>

        <div class="test-ui-status" id="test-ui-status"></div>
        
        <div class="test-ui-section">
            <label class="test-ui-label">ÈÄÅ‰ø°ÂÖà:</label>
            <select class="test-ui-select" id="test-target-select">
                <option value="all">ÂÖ®Âì° (All Players)</option>
                <option value="1">Player 1</option>
                <option value="2">Player 2</option>
                <option value="3">Player 3</option>
            </select>
        </div>
        
        <div class="test-ui-section">
            <label class="test-ui-label">„É°„ÉÉ„Çª„Éº„Ç∏:</label>
            <input type="text" class="test-ui-input" id="test-message-input" 
                   placeholder="„ÉÜ„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." value="„ÉÜ„Çπ„ÉàÈÄÅ‰ø°ÊàêÂäüÔºÅ">
        </div>
        
        <button class="test-ui-btn" id="test-alert-btn">
            üîî „Ç¢„É©„Éº„ÉàÈÄÅ‰ø°
        </button>
        
        <button class="test-ui-btn secondary" id="test-notification-btn">
            üí¨ ÈÄöÁü•ÈÄÅ‰ø° (3Áßí)
        </button>
        
        <button class="test-ui-btn warning" id="test-cue-btn">
            üéØ „Ç≠„É•„ÉºÈÄÅ‰ø°
        </button>
        
        <button class="test-ui-btn" id="test-countdown-btn">
            ‚è±Ô∏è „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ (4Â∞èÁØÄ)
        </button>
        
        <button class="test-ui-btn secondary" id="test-custom-btn">
            ‚ö° „Ç´„Çπ„Çø„É†„É°„ÉÉ„Çª„Éº„Ç∏
        </button>

        <div class="test-ui-section" style="margin-top: 10px;">
            <label class="test-ui-label">1Áßí„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ + „Éë„É´„Çπ:</label>
            <button class="test-ui-btn" id="player1-countdown-pulse-btn">üé∫ Player 1</button>
            <button class="test-ui-btn" id="player2-countdown-pulse-btn">üé∑ Player 2</button>
            <button class="test-ui-btn" id="player3-countdown-pulse-btn">ü•Å Player 3</button>
        </div>
    `;

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    const targetSelect = document.getElementById('test-target-select') as HTMLSelectElement;
    const messageInput = document.getElementById('test-message-input') as HTMLInputElement;

    const getTarget = () => targetSelect?.value || 'all';
    const getMessage = () => messageInput?.value || '„ÉÜ„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏';

    document.getElementById('test-alert-btn')?.addEventListener('click', () => {
        sendTestAlert(getMessage(), getTarget());
        console.log('‚úÖ „Ç¢„É©„Éº„ÉàÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('test-notification-btn')?.addEventListener('click', () => {
        sendTestNotification(getMessage(), 3000, getTarget());
        console.log('‚úÖ ÈÄöÁü•ÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('test-cue-btn')?.addEventListener('click', () => {
        sendTestCue(getMessage(), '#FF9800', getTarget());
        console.log('‚úÖ „Ç≠„É•„ÉºÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('test-countdown-btn')?.addEventListener('click', () => {
        sendCountdown(4, 0, getTarget());
        console.log('‚úÖ „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('test-custom-btn')?.addEventListener('click', () => {
        sendCustomMessage({
            custom: true,
            message: getMessage(),
            timestamp: Date.now()
        }, getTarget());
        console.log('‚úÖ „Ç´„Çπ„Çø„É†„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('player1-countdown-pulse-btn')?.addEventListener('click', () => {
        sendOneSecondCountdownAndPulse('1');
        console.log('‚úÖ Player 1 countdown + pulse ÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('player2-countdown-pulse-btn')?.addEventListener('click', () => {
        sendOneSecondCountdownAndPulse('2');
        console.log('‚úÖ Player 2 countdown + pulse ÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    document.getElementById('player3-countdown-pulse-btn')?.addEventListener('click', () => {
        sendOneSecondCountdownAndPulse('3');
        console.log('‚úÖ Player 3 countdown + pulse ÈÄÅ‰ø°ÂÆå‰∫Ü');
    });

    // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
    const statusEl = document.getElementById('test-ui-status');
    const statusMap = new Map<string, { message: string; cls: string }>();

    const renderStatus = () => {
        if (!statusEl) return;
        statusEl.innerHTML = Array.from(statusMap.values())
            .map(entry => `<div class="${entry.cls}">${entry.message}</div>`)
            .join('');
    };

    const setStatus = (key: string, message: string, cls: 'ok' | 'warn' | 'error' | 'info' = 'info') => {
        statusMap.set(key, { message, cls });
        renderStatus();
    };

    // Áí∞Â¢ÉÊÉÖÂ†±
    const hostInfo = window.location.host;
    setStatus('origin', `üîó ÁèæÂú®„ÅÆÊé•Á∂öÂÖà: ${hostInfo}`, 'info');

    if (window.location.hostname === 'localhost') {
        setStatus('origin-warning', '‚ö†Ô∏è „Çπ„Éû„Éõ„Å®ÈÄö‰ø°„Åô„Çã„Å´„ÅØ„ÄÅPCÂÅ¥„ÇÇ„Äåhttp://<IP„Ç¢„Éâ„É¨„Çπ>:1420„Äç„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warn');
    } else {
        setStatus('origin-warning', '‚úÖ PC „Å®„Çπ„Éû„Éõ„ÇíÂêå„Åò URL „Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'ok');
    }

    // „Éà„É©„É≥„Çπ„Éù„Éº„Éà„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    statusSubscription?.();
    statusSubscription = messenger.onStatusChange((status: MessengerStatus) => {
        switch (status.broadcast) {
            case 'connected':
                setStatus('transport-broadcast', '‚úÖ BroadcastChannel: Âà©Áî®ÂèØËÉΩ', 'ok');
                break;
            case 'error':
                setStatus('transport-broadcast', '‚ùå BroadcastChannel: „Ç®„É©„Éº', 'error');
                break;
            case 'unavailable':
                setStatus('transport-broadcast', '‚ö†Ô∏è BroadcastChannel: Êú™ÂØæÂøú„Éñ„É©„Ç¶„Ç∂', 'warn');
                break;
            default:
                setStatus('transport-broadcast', `‚ÑπÔ∏è BroadcastChannel: ${status.broadcast}`, 'info');
                break;
        }

        switch (status.websocket) {
            case 'connected':
                setStatus('transport-websocket', '‚úÖ WebSocket: Êé•Á∂öÊ∏à„Åø', 'ok');
                break;
            case 'connecting':
                setStatus('transport-websocket', '‚è≥ WebSocket: Êé•Á∂ö‰∏≠...', 'warn');
                break;
            case 'error':
                setStatus('transport-websocket', `‚ùå WebSocket: „Ç®„É©„Éº (${status.lastError ?? '‰∏çÊòé'})`, 'error');
                break;
            case 'disabled':
                setStatus('transport-websocket', '‚ÑπÔ∏è WebSocket: ÁÑ°Âäπ', 'info');
                break;
            default:
                setStatus('transport-websocket', `‚ÑπÔ∏è WebSocket: ${status.websocket}`, 'info');
                break;
        }
    });

    // Êé•Á∂öË®∫Êñ≠ (Ping ‚Üí Pong)
    const diagnosticId = `diag-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    let diagnosticResolved = false;

    setStatus('diagnostic', '‚è≥ Player „Åã„Çâ„ÅÆÂøúÁ≠î„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...', 'warn');

    diagnosticSubscription?.();
    diagnosticSubscription = messenger.onMessage((message: PerformanceMessage) => {
        if (message.type === 'diagnostic-pong' && message.data?.id === diagnosticId) {
            diagnosticResolved = true;
            const player = message.data?.player || '?';
            const origin = message.data?.origin || '(‰∏çÊòé)';
            setStatus('diagnostic', `‚úÖ Player ${player} „Åã„ÇâÂøúÁ≠î„ÇíÂèó‰ø° (${origin})`, 'ok');
        }
    });

    messenger.send({
        type: 'diagnostic-ping',
        target: 'all',
        data: {
            id: diagnosticId,
            sender: 'controller',
            origin: window.location.origin,
            timestamp: Date.now()
        }
    });

    window.setTimeout(() => {
        if (!diagnosticResolved) {
            setStatus('diagnostic', '‚ö†Ô∏è Player „Åã„ÇâÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇWebSocketÊé•Á∂ö„Åæ„Åü„ÅØURLË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        }
    }, 2500);

    console.log('üì± Simple Test UI created!');
    return container;
}

// „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºàÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´„Åã„Çâ‰ΩøÁî®ÂèØËÉΩÔºâ
if (typeof window !== 'undefined') {
    (window as any).playerMessenger = {
        sendToAllPlayers,
        sendToPlayer,
        sendToPlayers,
        sendTestAlert,
        sendTestNotification,
        sendTestCue,
        sendCountdown,
        sendCustomMessage,
        sendOneSecondCountdownAndPulse,
        createSimpleTestUI
    };
}
